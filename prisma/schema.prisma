// WMS (Warehouse Management System) Prisma Schema
// Comprehensive database design for warehouse and inventory management

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MASTER TABLES (기본 정보)
// ============================================================================

/// 사용자
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String?
  name      String?
  role      String   @default("user") // admin, manager, staff, viewer
  
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  grnReceived         GRN[]                @relation("receivedBy")
  grnApproved         GRN[]                @relation("approvedBy")
  outboundPicked      Outbound[]           @relation("pickedBy")
  outboundPacked      Outbound[]           @relation("packedBy")
  outboundShipped     Outbound[]           @relation("shippedBy")
  stockMovementInitiated StockMovement[]  @relation("initiatedBy")
  stockMovementVerified  StockMovement[]  @relation("verifiedBy")
  stockAuditedBy      StockAudit[]         @relation("auditedBy")
  stockAdjustedBy     StockAudit[]         @relation("adjustedBy")
  alertAssignedTo     Alert[]              @relation("assignedTo")
  alertAcknowledgedBy Alert[]              @relation("acknowledgedBy")
  alertResolvedBy     Alert[]              @relation("resolvedBy")
  auditLogsCreated    AuditLog[]           @relation("userId")

  @@index([role])
  @@index([isActive])
}

/// 창고
model Warehouse {
  id              String    @id @default(cuid())
  code            String    @unique @db.VarChar(20)
  name            String    @db.VarChar(100)
  description     String?   @db.Text
  
  // 주소 정보
  address         String?   @db.VarChar(255)
  city            String?   @db.VarChar(100)
  state           String?   @db.VarChar(100)
  zipCode         String?   @db.VarChar(20)
  country         String?   @db.VarChar(50)
  
  // 물리적 정보
  totalCapacity   Float?                 // m³ 또는 개수
  totalArea       Float?                 // m²
  noOfZones       Int      @default(0)
  noOfRacks       Int      @default(0)
  noOfLocations   Int      @default(0)
  
  // 담당자
  managerId       String?
  managerName     String?   @db.VarChar(100)
  contactPhone    String?   @db.VarChar(20)
  contactEmail    String?   @db.VarChar(100)
  
  // 운영 정보
  status          String    @default("active") // active, inactive, maintenance
  operationHours  String?   @db.VarChar(50)    // "09:00-18:00"
  allowsAfterHours Boolean  @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  zones           Zone[]
  locations       Location[]
  stocks          Stock[]
  grns            GRN[]
  outbounds       Outbound[]
  stockMovements  StockMovement[]
  stockAudits     StockAudit[]
  alerts          Alert[]

  @@index([status])
  @@index([code])
}

/// 구역 (Zone)
model Zone {
  id              String    @id @default(cuid())
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  code            String    @db.VarChar(10)
  name            String    @db.VarChar(100)
  description     String?   @db.Text
  
  // 물리적 정보
  capacity        Float?
  noOfRacks       Int      @default(0)
  
  // 특성
  zoneType        String    @default("general") // general, cold, hazmat, high-value
  temperature     Int?                          // 섭씨
  humidity        Int?                          // %
  
  status          String    @default("active") // active, inactive, reserved
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  locations       Location[]

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@index([status])
}

/// 위치 (Location)
model Location {
  id              String    @id @default(cuid())
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  zoneId          String
  zone            Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  
  code            String    @db.VarChar(50)  // A-01-1 (zone-rack-level)
  name            String?   @db.VarChar(100)
  
  // 물리적 정보
  rackNumber      String?   @db.VarChar(10)  // 01, 02
  level           Int?
  column          Int?
  
  // 용량
  maxCapacity     Float?
  currentUtilization Float? @default(0)
  
  // 타입
  locationType    String    @default("pallet") // pallet, daebong, box, shelf, bin
  
  status          String    @default("empty") // empty, occupied, reserved, damaged, maintenance
  allowsOverstock Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  stocks          Stock[]
  grnLineItems    GRNLineItem[]
  outboundLineItems OutboundLineItem[]
  stockMovements  StockMovement[]    @relation("toLocation")
  stockMovementsFrom StockMovement[]  @relation("fromLocation")

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@index([zoneId])
  @@index([status])
  @@index([code])
}

// ============================================================================
// PRODUCT TABLES (상품 정보)
// ============================================================================

/// 상품 마스터
model Product {
  id              String    @id @default(cuid())
  sku             String    @unique @db.VarChar(50)
  code            String?   @db.VarChar(50)
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  
  // 분류
  category        String?   @db.VarChar(100)
  subcategory     String?   @db.VarChar(100)
  
  // 물리적 정보
  weight          Float?                      // kg
  length          Float?                      // cm
  width           Float?
  height          Float?
  volume          Float?                      // m³
  
  // 규격
  unit            String?   @db.VarChar(20)   // EA, BOX, CASE
  unitsPerPack    Int?
  packsPerPallet  Int?
  
  // 가격/비용
  costPrice       Float?
  sellingPrice    Float?
  
  // 재고 관리
  minStockLevel   Int      @default(0)
  maxStockLevel   Int      @default(0)
  reorderPoint    Int      @default(0)
  leadTimeDays    Int      @default(0)
  
  // 특성
  isFragile       Boolean  @default(false)
  requiresTemperatureControl Boolean @default(false)
  isHazmat        Boolean  @default(false)
  isHighValue     Boolean  @default(false)
  
  status          String    @default("active") // active, discontinued, archived
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  skus            SKU[]
  grnLineItems    GRNLineItem[]
  outboundLineItems OutboundLineItem[]

  @@index([sku])
  @@index([category])
  @@index([status])
}

/// SKU (상품 변형)
model SKU {
  id              String    @id @default(cuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  skuCode         String    @unique @db.VarChar(50)
  variantName     String?   @db.VarChar(255)
  
  // 속성
  color           String?   @db.VarChar(50)
  size            String?   @db.VarChar(50)
  style           String?   @db.VarChar(50)
  
  // 바코드
  barcode         String?   @db.VarChar(50)
  
  // 재고 캐시 (빠른 조회)
  totalQuantity   Int      @default(0)
  availableQuantity Int    @default(0)
  reservedQuantity Int     @default(0)
  damagedQuantity Int      @default(0)
  
  status          String    @default("active") // active, inactive, discontinued
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  stocks          Stock[]
  stockMovements  StockMovement[]
  stockAudits     StockAudit[]

  @@index([productId])
  @@index([skuCode])
}

// ============================================================================
// INVENTORY TABLES (재고)
// ============================================================================

/// 재고
model Stock {
  id              String    @id @default(cuid())
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  skuId           String
  sku             SKU       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  
  // 수량 정보
  quantity        Int      @default(0)
  reserved        Int      @default(0)
  available       Int      @default(0)
  damaged         Int      @default(0)
  
  // 배치 정보 (Lot/Batch tracking)
  batchNumber     String?   @db.VarChar(50)
  expirationDate  DateTime?
  manufactureDate DateTime?
  
  // 입고 참조
  grnId           String?
  
  status          String    @default("available") // available, reserved, damaged, expired, blocked
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  histories       StockHistory[]

  @@unique([warehouseId, locationId, skuId, batchNumber])
  @@index([warehouseId])
  @@index([locationId])
  @@index([skuId])
  @@index([status])
  @@index([expirationDate])
}

/// 재고 조사 (Audit)
model StockAudit {
  id              String    @id @default(cuid())
  auditNumber     String    @unique @db.VarChar(50)
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  zoneId          String?
  locationId      String?
  skuId           String
  sku             SKU       @relation(fields: [skuId], references: [id])
  
  // 수량 정보
  systemQuantity  Int
  actualQuantity  Int
  variance        Int?
  
  // 조사 정보
  auditedById     String?
  auditedBy       User?     @relation("auditedBy", fields: [auditedById], references: [id])
  auditDate       DateTime  @default(now())
  
  // 조정 정보
  adjustmentRequired Boolean?
  adjustedById    String?
  adjustedBy      User?     @relation("adjustedBy", fields: [adjustedById], references: [id])
  adjustedAt      DateTime?
  adjustmentReason String?  @db.Text
  
  status          String    @default("pending") // pending, completed, discrepancy, resolved
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([auditNumber])
  @@index([warehouseId])
  @@index([status])
  @@index([auditDate])
}

/// 재고 변경 이력
model StockHistory {
  id              String    @id @default(cuid())
  stockId         String?
  stock           Stock?    @relation(fields: [stockId], references: [id], onDelete: SetNull)
  
  warehouseId     String
  skuId           String
  sku             SKU       @relation(fields: [skuId], references: [id])
  
  // 수량 변경
  previousQuantity Int?
  newQuantity     Int?
  quantityChange  Int?
  
  // 이유
  changeType      String   // inbound, outbound, adjustment, audit, damage, expiration
  referenceId     String?   @db.VarChar(100)
  reason          String?   @db.Text
  
  changedById     String?
  changedBy       User?     @relation("userId", fields: [changedById], references: [id])
  
  changedAt       DateTime  @default(now())

  @@index([stockId])
  @@index([skuId])
  @@index([changedAt])
}

// ============================================================================
// INBOUND TABLES (입고)
// ============================================================================

/// Goods Receipt Note (입고)
model GRN {
  id              String    @id @default(cuid())
  grnNumber       String    @unique @db.VarChar(50)
  poNumber        String?   @db.VarChar(50)
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  supplierId      String?
  supplierName    String?   @db.VarChar(255)
  
  // 일정
  expectedDeliveryDate DateTime?
  actualDeliveryDate DateTime?
  
  // 수량
  totalItems      Int      @default(0)
  totalQuantity   Int      @default(0)
  totalWeight     Float?
  totalVolume     Float?
  
  // 담당자
  receivedById    String?
  receivedBy      User?     @relation("receivedBy", fields: [receivedById], references: [id])
  approvedById    String?
  approvedBy      User?     @relation("approvedBy", fields: [approvedById], references: [id])
  
  status          String    @default("pending") // pending, partial, received, inspected, putaway, cancelled
  
  notes           String?   @db.Text
  referenceDocuments String? @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  lineItems       GRNLineItem[]
  stockMovements  StockMovement[]

  @@index([grnNumber])
  @@index([warehouseId])
  @@index([status])
  @@index([actualDeliveryDate])
}

/// GRN Line Item
model GRNLineItem {
  id              String    @id @default(cuid())
  grnId           String
  grn             GRN       @relation(fields: [grnId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  
  orderedQuantity Int
  receivedQuantity Int     @default(0)
  inspectedQuantity Int    @default(0)
  acceptedQuantity Int     @default(0)
  rejectedQuantity Int     @default(0)
  damagedQuantity  Int     @default(0)
  
  // 배치 정보
  batchNumber     String?   @db.VarChar(50)
  expirationDate  DateTime?
  manufactureDate DateTime?
  
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  
  status          String    @default("pending") // pending, received, inspected, accepted, rejected, putaway
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([grnId])
  @@index([productId])
}

// ============================================================================
// OUTBOUND TABLES (출고)
// ============================================================================

/// 출고
model Outbound {
  id              String    @id @default(cuid())
  outboundNumber  String    @unique @db.VarChar(50)
  
  orderId         String?   @db.VarChar(50)
  customerId      String?   @db.VarChar(50)
  customerName    String?   @db.VarChar(255)
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  shippingAddress String?   @db.Text
  
  // 수량
  totalItems      Int      @default(0)
  totalQuantity   Int      @default(0)
  totalWeight     Float?
  
  // 일정
  expectedShippingDate DateTime?
  actualShippingDate DateTime?
  
  // 배송
  shippingCarrier String?   @db.VarChar(100)
  trackingNumber  String?   @db.VarChar(100)
  
  // 담당자
  pickedById      String?
  pickedBy        User?     @relation("pickedBy", fields: [pickedById], references: [id])
  packedById      String?
  packedBy        User?     @relation("packedBy", fields: [packedById], references: [id])
  shippedById     String?
  shippedBy       User?     @relation("shippedBy", fields: [shippedById], references: [id])
  
  status          String    @default("pending") // pending, picking, picked, packing, packed, shipped, delivered, cancelled
  
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  lineItems       OutboundLineItem[]
  stockMovements  StockMovement[]

  @@index([outboundNumber])
  @@index([orderId])
  @@index([warehouseId])
  @@index([status])
}

/// Outbound Line Item
model OutboundLineItem {
  id              String    @id @default(cuid())
  outboundId      String
  outbound        Outbound  @relation(fields: [outboundId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  
  orderedQuantity Int
  pickedQuantity  Int      @default(0)
  packedQuantity  Int      @default(0)
  shippedQuantity Int      @default(0)
  
  pickedFromLocationId String?
  pickedFromLocation Location? @relation(fields: [pickedFromLocationId], references: [id])
  
  status          String    @default("pending") // pending, picked, packed, shipped
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([outboundId])
  @@index([productId])
}

// ============================================================================
// STOCK MOVEMENT TABLES
// ============================================================================

/// 재고 이동
model StockMovement {
  id              String    @id @default(cuid())
  movementNumber  String    @unique @db.VarChar(50)
  
  // 이동 유형
  movementType    String   // internal, inbound, outbound, return, adjustment
  
  fromWarehouseId String?
  fromLocationId  String?
  fromLocation    Location? @relation("fromLocation", fields: [fromLocationId], references: [id])
  
  toWarehouseId   String?
  warehouse       Warehouse? @relation(fields: [toWarehouseId], references: [id])
  toLocationId    String?
  toLocation      Location? @relation("toLocation", fields: [toLocationId], references: [id])
  
  skuId           String
  sku             SKU       @relation(fields: [skuId], references: [id])
  quantity        Int
  
  // 참조
  grnId           String?
  grn             GRN?      @relation(fields: [grnId], references: [id])
  outboundId      String?
  outbound        Outbound? @relation(fields: [outboundId], references: [id])
  orderId         String?   @db.VarChar(50)
  
  // 담당자
  initiatedById   String?
  initiatedBy     User?     @relation("initiatedBy", fields: [initiatedById], references: [id])
  verifiedById    String?
  verifiedBy      User?     @relation("verifiedBy", fields: [verifiedById], references: [id])
  
  status          String    @default("pending") // pending, in-transit, completed, cancelled, on-hold
  
  startTime       DateTime?
  completionTime  DateTime?
  reason          String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([movementNumber])
  @@index([movementType])
  @@index([status])
  @@index([skuId])
}

// ============================================================================
// ALERT TABLES (알림)
// ============================================================================

/// Alert
model Alert {
  id              String    @id @default(cuid())
  alertCode       String    @db.VarChar(50)
  alertType       String   // info, warning, critical, error
  
  warehouseId     String?
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id])
  skuId           String?
  locationId      String?
  
  title           String    @db.VarChar(255)
  message         String    @db.Text
  
  triggerValue    Float?
  currentValue    Float?
  threshold       Float?
  
  status          String    @default("active") // active, acknowledged, resolved, dismissed
  
  assignedToId    String?
  assignedTo      User?     @relation("assignedTo", fields: [assignedToId], references: [id])
  acknowledgedById String?
  acknowledgedBy  User?     @relation("acknowledgedBy", fields: [acknowledgedById], references: [id])
  resolvedById    String?
  resolvedBy      User?     @relation("resolvedBy", fields: [resolvedById], references: [id])
  
  triggeredAt     DateTime  @default(now())
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?
  
  actionRequired  String?   @db.VarChar(255)
  actionTaken     String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  history         AlertHistory[]

  @@index([warehouseId])
  @@index([status])
  @@index([alertType])
  @@index([triggeredAt])
  @@index([assignedToId])
}

/// Alert History
model AlertHistory {
  id              String    @id @default(cuid())
  alertId         String
  alert           Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  previousStatus  String?   @db.VarChar(50)
  newStatus       String    @db.VarChar(50)
  changedById     String?
  changedBy       User?     @relation(fields: [changedById], references: [id])
  
  action          String?   @db.VarChar(255)
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())

  @@index([alertId])
}

// ============================================================================
// AUDIT & LOG TABLES
// ============================================================================

/// Audit Log
model AuditLog {
  id              String    @id @default(cuid())
  
  userId          String?
  user            User?     @relation("userId", fields: [userId], references: [id])
  username        String?   @db.VarChar(100)
  
  action          String    @db.VarChar(100)
  entityType      String    @db.VarChar(100)
  entityId        String    @db.VarChar(255)
  
  oldValues       String?   @db.Text           // JSON
  newValues       String?   @db.Text           // JSON
  
  ipAddress       String?   @db.VarChar(50)
  userAgent       String?   @db.Text
  sessionId       String?   @db.VarChar(255)
  
  status          String    @default("success") // success, failure, partial
  errorMessage    String?   @db.Text
  
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
}

/// System Log
model SystemLog {
  id              String    @id @default(cuid())
  
  level           String   // debug, info, warn, error, critical
  category        String    @db.VarChar(100)
  message         String    @db.Text
  
  stackTrace      String?   @db.Text
  metadata        String?   @db.Text           // JSON
  
  createdAt       DateTime  @default(now())

  @@index([level])
  @@index([category])
  @@index([createdAt])
}
